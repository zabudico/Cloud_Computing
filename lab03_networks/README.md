# Лабораторная работа №3. Облачные сети

## Цели работы

Научиться вручную создавать виртуальную сеть (VPC) в AWS, добавлять в неё подсети, таблицы маршрутов, интернет-шлюз (IGW) и NAT Gateway, а такжетраивать взаимодействие между веб-сервером в публичной подсети и сервером базы данных в приватной.

После выполнения работы:

- понимаю, как формируется изоляция сетей в AWS (VPC);
- умею создавать и связывать компоненты сети;
- знаю, как EC2-инстансы разных подсетей взаимодействуют друг с другом;
- различаю публичные и приватные маршруты.

## Условия

_Amazon VPC (Virtual Private Cloud)_ — это собственная виртуальная сеть в облаке AWS.
Она полностью изолирована от других пользователей и позволяет вам управлять адресным пространством, подсетями, шлюзами и безопасностью.

В типичном сценарии у есть:

- _Публичная подсеть_. Для веб-сервера (имеет выход в интернет).
- _Приватная подсеть_. Для базы данных (без прямого доступа извне).
- _NAT Gateway_. Чтобы приватные ресурсы имели доступ в интернет (например, для обновления ПО).
- _Route Tables_. Определяют, куда направлять трафик.
- _Security Groups_. Управляют входящими и исходящими соединениями на уровне инстансов.
- _EC2-инстансы_. Веб-сервер, сервер базы данных и bastion host.

Конечная архитектура сети, созданной в этой лабораторной работе, будет выглядеть следующим образом:

![Архитектура сети](/lab03_networks/img/image.png)

### Шаг 1. Подготовка среды

1. Вошёл в AWS Management Console.
2. Убедился, что регион установлен на `Frankfurt` (eu-central-1).
3. В строке поиска ввёл _VPC_ и открыл консоль.
   
<img width="943" height="856" alt="aws_1" src="https://github.com/user-attachments/assets/759581d1-1e97-458c-88c9-06b57f70ad00" />

### Шаг 2. Создание VPC

1. В левой панели выбрал `Your VPCs` → `Create VPC`.
2. Указал:
   1. `Name tag`: `zabudico-vpc-k21` (где `21` — порядковый номер).
   2. `IPv4 CIDR block`: `10.(k%30).0.0/16`
      > Пример: если `k = 12`, использую `10.12.0.0/16`. Если `k = 31`, использую `10.1.0.0/16`.
   3. `Tenancy`: Default
      > Что обозначает маска `/16`? И почему нельзя использовать, например, `/8`?
3. нажал `Create VPC`.

_VPC_ — это “контейнер” для подсетей. Внутри одной VPC можно создавать десятки подсетей с разными маршрутами и правилами.

<img width="1012" height="707" alt="aws_2" src="https://github.com/user-attachments/assets/b7741443-b3c0-4ec5-9a41-9b9604a9edcb" />

<img width="1637" height="697" alt="aws_2_1" src="https://github.com/user-attachments/assets/92708779-60df-47b3-a9cb-d238afb3a549" />

### Шаг 3. Создание Internet Gateway (IGW)

Internet Gateway позволяет ресурсам внутри VPC выходить в Интернет. _Без него публичные IP-адреса не будут работать_. Если  виртуальной машине (EC2) назначен публичный IP, но нет IGW, она не сможет общаться с внешним миром.

1. В левой панели выбрал `Internet Gateways` → `Create internet gateway`.
2. Указал имя: `zabudico-igw-k21`.
3. Теперь нужно “прикрепить” (Attach) шлюз к  сети:
   1. выбрал созданный IGW.
   2. нажал `Actions` → `Attach to VPC`.
   3. В списке выбрал `zabudico-vpc-k21`.
   4. подтвердил действие.

<img width="944" height="552" alt="aws_3" src="https://github.com/user-attachments/assets/3e1d76c0-6739-4e0a-8887-3271ff133c4c" />

<img width="687" height="594" alt="aws_3_1" src="https://github.com/user-attachments/assets/34c02bb9-10fb-4729-9905-3b9d6d281e8d" />

<img width="936" height="699" alt="aws_3_2" src="https://github.com/user-attachments/assets/c4d93472-248b-459d-a021-df23a4f1f1f9" />

<img width="691" height="700" alt="aws_3_3" src="https://github.com/user-attachments/assets/db687f8d-7996-4133-ac21-21185f134e7c" />

### Шаг 4. Создание подсетей

_Подсети (subnets)_ — это сегменты внутри VPC, которые позволяют изолировать ресурсы. То есть, подсети создаются для разделения ресурсов по функционалу и уровню доступа и для более гибкого управления трафиком.

#### Шаг 4.1. Создание публичной подсети

Теперь, когда у есть VPC и Internet Gateway, создам первую подсеть — публичную.
Эта подсеть будет содержать ресурсы, которым нужен прямой доступ из Интернета.

1. В левой панели выбрал `Subnets` → `Create subnet`.
2. Указал:
   1. `VPC ID`: выбрал сеть `zabudico-vpc-k21`
   2. `Subnet name`: `public-subnet-k21`
   3. `Availability Zone`: `eu-central-1a`
      > AWS создаёт подсети в конкретных зонах доступности; в этом случае выбераю первую
   4. `IPv4 CIDR block`: `10.(k%30).1.0/24`
      > Диапазон IP-адресов, которые будут выданы ресурсам в этой подсети
3. нажал `Create subnet`.

> Является ли подсеть "публичной" на данный момент? Почему?

#### Шаг 4.2. Создание приватной подсети

Подсеть называется приватной, если её трафик не направляется напрямую в Интернет.

1. нажал `Create subnet` ещё раз.
2. Указал:
   1. `VPC ID`: выбрал сеть `zabudico-vpc-k21`
      > использую ту же VPC, чтобы обе подсети могли взаимодействовать между собой.
   2. `Subnet name`: `private-subnet-k21`
   3. `Availability Zone`: _выбрал другую зону_
   4. `IPv4 CIDR block`: `10.(k%30).2.0/24`
      > Диапазон адресов не должен пересекаться с диапазоном публичной подсети.
3. нажал `Create subnet`.

<img width="1625" height="745" alt="aws_4" src="https://github.com/user-attachments/assets/0f236951-9e45-4e3a-8bb8-17bbaa17460b" />

<img width="1640" height="771" alt="aws_4_1" src="https://github.com/user-attachments/assets/8224795d-16e9-4af2-99a9-a0b1a9eb60cf" />

> Является ли подсеть "приватной" на данный момент? Почему?

### Шаг 5. Создание таблиц маршрутов (Route Tables)

Теперь, когда есть две подсети (публичная и приватная), необходимотроить маршруты (Route Tables), которые определяют, как сетевой трафик будет двигаться внутри нашей VPC.

По умолчанию каждая новая VPC имеет одну основную таблицу маршрутов, и все новые подсети автоматически к ней подключаются. Если зайду в `Route Tables`, увижу одну таблицу, связанную с  VPC.

Но для лучшей структуры и изоляции создам:

- отдельную таблицу маршрутов для публичной подсети (с доступом к Интернету через IGW),
- отдельную таблицу маршрутов для приватной подсети (с доступом к Интернету через NAT Gateway).

#### Шаг 5.1. Создание публичной таблицы маршрутов

1. В левой панели выбрал `Route Tables` → `Create route table`.
2. Указал:
   1. `Name tag`: `public-rt-k21`
   2. `VPC`: `zabudico-vpc-k21`
   3. нажал `Create route table`
   4. перешёл на вкладку `Routes` и нажал `Edit routes` → `Add route`.
   5. заполнил:
      1. `Destination`: 0.0.0.0/0
         > Это означает “весь остальной трафик, не относящийся к внутренним адресам VPC”.
      2. `Target`: выбрал Internet Gateway (`zabudico-igw-k21`).
   6. нажал `Save changes`.
   7. перешёл на вкладку `Subnet associations` → `Edit subnet associations`.
      > Зачем необходимо привязать таблицу маршрутов к подсети?
   8. отеметил `public-subnet-k21` и нажал `Save associations`.

Теперь трафик из публичной подсети (например, от веб-сервера или NAT Gateway) будет отправляться наружу через Internet Gateway. Связь `“0.0.0.0/0 → IGW”` — именно то, что делает подсеть публичной.

#### Шаг 5.2. Создание приватной таблицы маршрутов

1. нажал `Create route table` ещё раз.
2. Указал:
   1. `Name tag`: `private-rt-k21`
   2. `VPC`: `zabudico-vpc-k21`
   3. нажал `Create route table`.
3. перешёл на вкладку `Subnet associations` → `Edit subnet associations`.
4. отеметил `private-subnet-k21` и нажал `Save associations`.

На данный момент все ресурсы, которые будут созданы в приватной подсети, не смогут выходить в Интернет, так как нет NAT Gateway и соответствующего маршрута.

<img width="1642" height="527" alt="aws_5" src="https://github.com/user-attachments/assets/b4fcfb61-f718-4704-9cf3-886c9901d1bc" />

<img width="941" height="723" alt="aws_5_1" src="https://github.com/user-attachments/assets/fd4a1892-b2f9-41a6-b423-56794d4b48dd" />

<img width="1634" height="587" alt="aws_5_2" src="https://github.com/user-attachments/assets/2ee3cf97-4f99-45f2-9bef-b4981fb91177" />

<img width="939" height="462" alt="aws_5_3" src="https://github.com/user-attachments/assets/7b65061e-e717-4d2e-8796-c51d8ea2fe17" />

<img width="941" height="459" alt="aws_5_4" src="https://github.com/user-attachments/assets/71ddb956-a840-4319-9d63-b2743f6d12a7" />

### Шаг 6. Создание NAT Gateway

NAT Gateway позволяет ресурсам в приватной подсети выходить в Интернет (например, для обновления ПО), при этом оставаясь недоступными извне.

> Как работает NAT Gateway?

#### Шаг 6.1. Создание Elastic IP

_Elastic IP_ — это статический публичный IPv4-адрес, закреплённый за  аккаунтом AWS.
Он используется для NAT Gateway, чтобы тот мог представлять собой “точку выхода” в Интернет от имени всех приватных инстансов.

1. В левой панели выбрал `Elastic IPs` → `Allocate Elastic IP address`.
2. нажал Allocate.

#### Шаг 6.2. Создание NAT Gateway

1. В левой панели выбрал `NAT Gateways` → `Create NAT gateway`.
2. Указал:
   1. `Name tag`: `nat-gateway-k21`
   2. `Subnet`: выбрал публичную подсеть (`public-subnet-k21`)
      > NAT Gateway всегда создаётся в публичной подсети, потому что ему нужен прямой выход в Интернет через IGW.
   3. `Connectivity type`: `Public`
   4. `Elastic IP allocation ID`: выбрал EIP, созданный на предыдущем шаге.
3. нажал `Create NAT gateway`.

Подождал 2–3 минуты, пока статус изменится с `Pending` на `Available`. Это значит, что NAT Gateway готов к работе.

#### Шаг 6.3. Изменение приватной таблицы маршрутов

1. вернулся в `Route Tables` и выбрал `private-rt-k21`.
2. перешёл на вкладку `Routes` и нажал `Edit routes` → `Add route`.
3. заполнил:
   1. `Destination`: `0.0.0.0/0`
   2. `Target`: выбрал NAT Gateway (`nat-gateway-k21`).
4. нажал `Save changes`.

Теперь ресурсы в приватной подсети смогут выходить в Интернет через NAT Gateway.

<img width="1817" height="727" alt="aws_6" src="https://github.com/user-attachments/assets/ba05af2a-1935-4852-b7bb-3f8945541e24" />

<img width="1629" height="571" alt="aws_6_1" src="https://github.com/user-attachments/assets/c4e7c0f8-91a5-4e39-a69f-f12fa4adacf6" />

<img width="662" height="682" alt="aws_6_2" src="https://github.com/user-attachments/assets/73745c2d-fcb4-4bb8-adab-64bdfbd364bd" />

<img width="667" height="609" alt="aws_6_3" src="https://github.com/user-attachments/assets/8dc7b62d-bc42-41a9-a37a-bc3761197fe7" />

<img width="939" height="734" alt="aws_6_4" src="https://github.com/user-attachments/assets/54c7d4c3-4a7a-45c4-85c5-85ccd7af975f" />

### Шаг 7. Создание Security Groups

_Security Group (SG)_ — это виртуальный брандмауэр на уровне инстанса (EC2), который контролирует входящий (Inbound) и исходящий (Outbound) трафик.

1. В левой панели выбрал `Security Groups` → `Create security group`.
2. Указал:
   1. `Security group name`: `web-sg-k21`
   2. `Description`: `Security group for web server`
   3. `VPC`: выбрал VPC (`zabudico-vpc-k21`)
3. В разделе Inbound rules добавил правила разрешающее следующие типы трафика:
   1. Тип: `HTTP`, Протокол: `TCP`, Порт: `80`, Источник: `0.0.0.0/0`
   2. Тип: `HTTPS`, Протокол: `TCP`, Порт: `443`, Источник: `0.0.0.0/0`
4. Создал еще две Security Groups:
   1. `bastion-sg-k21` для bastion host с разрешением входящего трафика на порт `22` (SSH) только из IP-адреса.
   2. `db-sg-k21` для базы данных с разрешением входящего трафика:
      1. Тип: `MySQL/Aurora`, Протокол: `TCP`, Порт: `3306`, Источник: `web-sg-k21` (разрешаю доступ только с веб-сервера)
      2. Тип: `SSH`, Протокол: `TCP`, Порт: `22`, Источник: `bastion-sg-k21` (разрешаю доступ только с bastion host)
     
   <img width="1800" height="408" alt="aws_7_1" src="https://github.com/user-attachments/assets/50983e84-ebc0-4dd7-84bc-a02d13b9b03d" />
   
<img width="1801" height="474" alt="aws_7_2" src="https://github.com/user-attachments/assets/7cb1bb95-56d8-4355-812e-5bd58b33e40e" />


> Что такое _Bastion Host_ и зачем он нужен в архитектуре с приватными подсетями?

### Шаг 8. Создание EC2-инстансов

Создал три EC2-инстанса, которые будут выполнять следующие роли:

- _Веб-сервер_ (`web-server`) - в публичной подсети, доступен из Интернета по HTTP.
- _Сервер базы данных_ (`db-server`) - в приватной подсети, недоступен напрямую извне.
- _Bastion Host_ (`bastion-host`) - в публичной подсети, для безопасного доступа к приватным ресурсам.

1. В строке поиска AWS Console ввёл `EC2` и открыл консоль.
2. Создал 3 инстанса, следуя инструкциям ниже.

_Для всех инстансов использую_:

- AMI: `Amazon Linux 2 AMI (HVM), SSD Volume Type`
- Тип инстанса: `t3.micro`
- Ключ доступа (Key Pair): Создал новый ключ `zabudico-key-k21` и скачал его.
- Хранилище: оставил по умолчанию (8 ГБ).
- Теги: добавил тег `Name` с соответствующим именем инстанса.

Для `web-server`:

1. выбрал сеть `VPC`: `zabudico-vpc-k21`
2. Подсеть `Subnet`: `public-subnet-k21`
3. `Auto-assign Public IP`: `Enable`
4. `Security Group`: выбрал `web-sg-k21`
5. В разделе `Advanced Details` в поле `User data` вставил следующий скрипт для автоматической установки веб-сервера:

   ```bash
#!/bin/bash
dnf install -y httpd php
echo "<?php phpinfo(); ?>" > /var/www/html/index.php
systemctl enable httpd
systemctl start httpd
   ```

Для `db-server`:

1. выбрал сеть `VPC`: `zabudico-vpc-k21`
2. Подсеть `Subnet`: `private-subnet-k21`
3. `Auto-assign Public IP`: `Disable`
4. `Security Group`: выбрал `db-sg-k21`
5. В разделе `Advanced Details` в поле `User data` вставил следующий скрипт для автоматической установки MySQL сервера:

   ```bash
#!/bin/bash
dnf install -y mariadb105-server
systemctl enable mariadb
systemctl start mariadb
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'StrongPassword123!'; FLUSH PRIVILEGES;"
   ```

Для `bastion-host`:

1. выбрал сеть `VPC`: `zabudico-vpc-k21`
2. Подсеть `Subnet`: `public-subnet-k21`
3. `Auto-assign Public IP`: `Enable`
4. `Security Group`: выбрал `bastion-sg-k21`
5. В разделе `Advanced Details` в поле `User data` вставил следующий скрипт для автоматической установки MySQL клиента:

   ```bash
#!/bin/bash
dnf install -y mariadb105
   ```
<img width="981" height="710" alt="aws_8" src="https://github.com/user-attachments/assets/6896ac50-d139-4166-870b-ece381e38c84" />

<img width="884" height="758" alt="aws_8_1" src="https://github.com/user-attachments/assets/768b5d3a-8409-4fea-aa66-331f87fe8f35" />

<img width="887" height="748" alt="aws_8_2" src="https://github.com/user-attachments/assets/6974cbaf-1a69-47bc-b2a1-c6539a35106d" />

### Шаг 9. Проверка работы

На этом этапе создал:

- виртуальную сеть (VPC)
- публичную и приватную подсети
- интернет-шлюз (IGW)
- NAT Gateway
- две таблицы маршрутов
- три экземпляра EC2 (Web, DB и Bastion)
- три Security Group

Теперь важно убедиться, что сеть функционирует корректно и что приватная подсеть действительно изолирована от внешнего мира.

1. Подождал, пока все инстансы запустятся (статус `running`).
2. Нашёл публичный IP-адрес `web-server` и открыл его в браузере. Увидел страницу с информацией о PHP.
3. Подключился к `bastion-host` по SSH:
   ```bash
   ssh -i <your-nickname>-key.pem ec2-user@<Bastion-Host-Public-IP>
   ```
4. Проверил подключение к интернету с `bastion-host` выполнив `ping`:

   ```bash
      ping -c 4 google.com
   ```

   > Если пинги успешны, значит публичная подсеть и IGWтроены правильно.

   Не получается. Это по тому, что в inbound rules стоит web-sg-k21, а не bastion-sg-k21, по этому чтобы проверить подключение к базе придётся либо менять security group либо ставить mysql клиент на web сервер.


5. С `bastion-host` попробывал подключиться к `db-server`:
   ```bash
   mysql -h <DB-Server-Private-IP> -u root -p
   ```
   > Если подключение успешно, значит приватная подсеть и NAT Gatewayтроены правильно.

   ** Попытка подключиться к БД с бастиона (как в задании) закончилась провалом ! **

   Вариант(наиболее безопасный) решения данной проблемы:
   Поставить MySQL-клиент на web-сервере (он в web-sg-k21), и выполнить:

   # SSH на web
```bash
   ssh -i zabudico-key-k21.pem ec2-user@18.194.183.176
   sudo yum install -y mariadb
   mysql -h 10-21-0-190 -u root -p
```

   Это строго соответствует текущему inbound правилу 3306 → web-sg-k21 и ничего не ослабляет.

6. Вышел из `db-server` и `bastion-host`.

<img width="973" height="1010" alt="aws_9" src="https://github.com/user-attachments/assets/450a245c-7203-48c1-81ea-0176352427c3" />

<img width="967" height="580" alt="aws_9_1" src="https://github.com/user-attachments/assets/f0aaf20b-5955-49c6-989f-a3958ff278e0" />


### Шаг 10. Дополнительные задания. Подключение в приватную подсеть через Bastion Host

Не смог выполнить, так как по текущим правилам безопасности (из задания) db-sg-k21 впускает MySQL(3306) только от web-sg-k21. Бастион не входит в этот SG, поэтому mysql -h 10-21-0-190 с бастиона не пройдёт — и это правильно с точки зрения безопасности.

У пользователя нет прямого доступа к приватной подсети, но он может подключиться к `db-server` через `bastion-host`.

использую SSH Agent Forwarding для упрощения доступа:

1. На  локальной машине. Это запустит SSH Agent и добавит приватный ключ в агент:

   ```bash
   eval "$(ssh-agent -s)"
   ssh-add <your-nickname>-key.pem
   ```

2. Подключаемся к `bastion-host` с опцией `-A` и '-J':

   ```bash
   ssh -A -J ec2-user@<Bastion-Host-Public-IP> ec2-user@<DB-Server-Private-IP>
   ```

   > Что делает опция `-A` и `-J`?

3. Обновляем систему на `db-server`:
   ```bash
   sudo dnf update -y
   ```
4. Устанавливаем `htop`:

   ```bash
   sudo dnf install -y htop
   ```

   > Если обновление и установка прошли успешно, значит NAT Gateway работает корректно.

5. Подключаемся к MySQL серверу:

   ```bash
   mysql -u root -p
   ```

   > Не установлен mysql клиент, устанавливаем его командой `sudo dnf install -y mariadb105`.
   > вводим пароль `StrongPassword123!`.

6. Выходим из MySQL и затем из `db-server` и `bastion-host`.
7. На локальном компьютере, завершаем работу с SSH Agent:
   ```bash
   ssh-agent -k
   ```

## Завершение работы

После выполнения всех шагов, не забыл удалить созданные ресурсы в AWS, чтобы избежать ненужных затрат. Выполнил удаление в следующем порядке:

1. Удалил EC2-инстансы.
2. Удалил NAT Gateway (подождал, пока он будет удалён).
3. Удалил Elastic IP.
   1. `VPC` -> `Elastic IPs` -> выбрал EIP -> `Actions` -> `Release Elastic IP addresses`.
4. Удалил Security Groups.
   1. `VPC` -> `Security Groups` -> выбрал нужную группу -> `Actions` -> `Delete Security Group`.
5. Удалил Internet Gateway.
   1. `VPC` -> `Internet Gateways` -> выбрал IGW -> `Actions` -> `Detach from VPC` -> подтвердил.
   2. Затем снова выбрал IGW -> `Actions` -> `Delete internet gateway`.
6. Удалил созданную VPC.
   1. `VPC` -> `Your VPCs` -> выбрал VPC -> `Actions` -> `Delete VPC`.
   2. подтвердил удаление.
   3. Если удаление не удаётся, проверил, что все ресурсы (подсети, таблицы маршрутов и т.д.) были удалены.

> Удаление ресурсов в неправильном порядке может привести к ошибкам, так как некоторые ресурсы зависят от других.

Для того, чтобы кредины не снимались, то достаточно удалить EC2 инстансы, NAT Gateway и Elastic IP. Остальные ресурсы можно оставить, так как они не тарифицируются отдельно.

## Контрольные вопросы

1. Что обозначает маска /16? И почему нельзя использовать, например, /8?

/16 в CIDR-нотации означает, что первые 16 бит IP-адреса зафиксированы как сетеввая часть, а оставшиеся 16 бит (2 байта) можно использовать для адресации хостов внутри сети. Для сети 10.12.0.0/16 это дает диапазон адресов от 10.12.0.1 до 10.12.255.254.

Почему нельзя использовать /8 (например, 10.0.0.0/8)?

Слишком большой размер: Маска /8 предоставляет огромное адресное пространство (~16.7 млн. адресов). VPC такого размера непрактична и избыточна для большинства задач.

Ограничения AWS: AWS накладывает ограничения на размер блока CIDR для VPC. Минимальный размер — /28, максимальный — /16. Использование /8 просто технически невозможно в рамках правил платформы.

2. Является ли подсеть "публичной" на данный момент? Почему?

Нет, не является. На момент создания подсети с именем public-subnet-k21 она еще не является публичной. Подсеть становится публичной только после того, как ее таблица маршрутов получает запись, направляющую интернет-трафик (0.0.0.0/0) на Internet Gateway (IGW). Изначально подсеть использует основную таблицу маршрутов VPC, в которой нет такого правила.

3. Является ли подсеть "приватной" на данный момент? Почему?

Да, является, но по умолчанию. На момент создания подсеть private-subnet-k21 является приватной, потому что в ее таблице маршрутов (на тот момент — основной таблице VPC) нет маршрута в интернет через IGW. Однако, чтобы быть полноценной "приватной подсетью с выходом в интернет", ей позже потребуется маршрут через NAT Gateway, который вы и добавили.

4. Зачем необходимо привязать таблицу маршрутов к подсети?

Таблица маршрутов определяет правила движения трафика. Привязка таблицы маршрутов к подсети сообщает VPC: "Весь трафик, исходящий из этой конкретной подсети, должен следовать правилам из этой конкретной таблицы". Без этой ассоциации подсеть будет использовать основную таблицу маршрутов VPC, что лишает гибкости в управлении сетевым трафиком.

5. Как работает NAT Gateway?

NAT (Network Address Translation) Gateway позволяет инстансам в приватных подсетях устанавливать исходящие соединения с интернетом (например, для загрузки обновлений), при этом блокируя любые входящие инициативные соединения из интернета.

Принцип работы:

Инстанс в приватной подсети отправляет запрос во внешний мир (например, на api.github.com).

Таблица маршрутов приватной подсети направляет этот трафик на NAT Gateway.

NAT Gateway, находясь в публичной подсети, заменяет приватный IP-адрес источника на свой собственный публичный IP и отправляет запрос дальше через IGW.

Когда ответ приходит, NAT Gateway, используя собственную таблицу трансляции, определяет, какому приватному инстансу принадлежит этот ответ, и пересылает его обратно.

6. Что такое Bastion Host и зачем он нужен в архитектуре с приватными подсетями?

Bastion Host (Jump Host) — это специально настроенный сервер, размещенный в публичной подсети, который служит единственной точкой входа для SSH- или RDP-доступа к инстансам в приватных подсетях.

Зачем он нужен:

Безопасность: Вместо того чтобы давать каждому приватному инстансу публичный IP или открывать SSH-порт для всего мира, вы жестко контролируете доступ через один единственный хост. Это drastically уменьшает "поверхность атаки".

Аудит: Все сессии администраторов проходят через один хост, что упрощает логирование и аудит действий.

Соответствие: Помогает соответствовать требованиям безопасности, которые запрещают прямой доступ к базам данных или бэкенд-серверам из публичного интернета.

7. Что делает опция -A и -J?

-A (SSH Agent Forwarding): Эта опция "пересылает" аутентификацию вашего локального SSH-агента через цепочку подключений. Это позволяет вам использовать ваш локальный приватный ключ для аутентификации на последующих серверах в цепочке, без необходимости копировать приватный ключ на Bastion Host. Это более безопасный способ.

-J (Jump Host): Эта опция указывает SSH-клиенту, что для подключения к целевому хосту (db-server) необходимо сначала установить соединение через промежуточный хост (bastion-host). Команда вида ssh -J user@jump-host user@target-host является современным и компактным эквивалентом старого метода с использованием ProxyCommand.


### Список использованных источников

1. **AWS Documentation - Amazon VPC**
   - Официальная документация по созданию и настройке Virtual Private Cloud
   - URL: https://docs.aws.amazon.com/vpc/

2. **AWS Documentation - VPC Networking Components**
   - Подробное описание компонентов VPC: подсетей, таблиц маршрутов, шлюзов
   - URL: https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Networking.html

3. **AWS Documentation - NAT Gateway**
   - Руководство по созданию и настройке NAT Gateway
   - URL: https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html

4. **AWS Documentation - Security Groups**
   - Документация по настройке групп безопасности
   - URL: https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html

5. **AWS Documentation - EC2 Instance User Data**
   - Использование User Data для автоматической настройки инстансов
   - URL: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html

6. **SSH Agent Forwarding Guide**
   - Руководство по использованию SSH Agent Forwarding
   - URL: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/using-ssh-agent-forwarding

### Дополнительные важные аспекты

1. **Стоимостные соображения**:
   - NAT Gateway тарифицируется по часам работы и за объем обработанного трафика
   - Elastic IP бесплатен только когда присоединен к работающему инстансу
   - Рекомендуется всегда удалять неиспользуемые ресурсы во избежание неожиданных расходов

2. **Рекомендации по безопасности**:
   - Bastion host следует размещать в отдельной публичной подсети с минимальными правами
   - Для Production сред рекомендуется использовать Network ACLs в дополнение к Security Groups
   - Пароли БД следует хранить в AWS Secrets Manager, а не в User Data

3. **Лучшие практики**:
   - Использовать разные Availability Zones для повышения отказоустойчивости
   - Регулярно обновлять AMI и устанавливать security patches
   - Настроить мониторинг и логирование через CloudWatch

4. **Масштабирование**:
   - Для веб-сервера можно позже добавить Application Load Balancer
   - Для БД можно рассмотреть Amazon RDS вместо self-managed MySQL
   - Можно автоматизировать развертывание через CloudFormation или Terraform

5. **Диагностика проблем**:
   - Использовать VPC Flow Logs для анализа сетевого трафика
   - Проверять Route Tables при проблемах с подключением
   - Убедиться, что Security Groups разрешают нужные порты и протоколы

6. **Особенности регионов**:
   - Некоторые типы инстансов могут быть недоступны в определенных регионах
   - Стоимость услуг может различаться в зависимости от региона
   - Выбор региона влияет на latency для конечных пользователей

### Вывод по проделанной лабораторной работе №3
   
   В ходе выполнения лабораторной работы "Облачные сети" я успешно создал и настроил изолированную сетевую инфраструктуру в AWS, соответствующую лучшим практикам проектирования облачных сред.

   Основные достижения:

   * Создана полнофункциональная VPC-архитектура:

   *Развернута виртуальная частная сеть (VPC) с адресным пространством 10.22.0.0/16

   * Реализовано разделение на публичную и приватную подсети в разных зонах доступности

   * Настроен Internet Gateway для выхода в интернет из публичной подсети

   * Создан и настроен NAT Gateway для контролируемого доступа в интернет из приватной подсети

   * Реализована система безопасности:

   * Настроены Security Groups с принципом минимальных привилегий:

   * Web-SG - доступ по HTTP/HTTPS для всех

   * DB-SG - доступ к MySQL только с веб-сервера, SSH только с бастион-хоста

   * Bastion-SG - ограниченный SSH-доступ

   * Развернута трехуровневая архитектура приложения:

   * Веб-сервер в публичной подсети с автоматической установкой Apache и PHP

   * Сервер БД в приватной подсети с установкой MariaDB

   * Bastion Host для безопасного администрирования

   Проблемы и их решения:
   
   В процессе работы столкнулся с несколькими техническими вызовами:

   *Проблема подключения к БД с Bastion Host - изначальная конфигурация Security Groups преднамеренно запрещала прямой доступ к БД с бастиона. Решил установкой MySQL-клиента на веб-сервер и подключением оттуда, что соответствует принципу безопасности "минимальные привилегии".

   *Понимание момента "публичности" подсети - осознал, что подсеть становится публичной только после привязки к таблице маршрутов с IGW, а не в момент создания.

   Приобретенные навыки:

   * Научился создавать и связывать компоненты AWS VPC (подсети, таблицы маршрутов, шлюзы)

   * Понял принципы сетевой изоляции в облаке и различия между публичными и приватными маршрутами

   * Освоил настройку Security Groups для контроля доступа на уровне инстансов

   * Научился диагностировать проблемы сетевого подключения в облачной среде

   * Понял практическое применение NAT Gateway и Bastion Host в реальных сценариях

   
### Вывод:
   
   Лабораторная работа позволила не только теоретически изучить, но и практически применить принципы построения безопасной и отказоустойчивой сетевой инфраструктуры в AWS. Полученные знания имеют прямую практическую ценность для построения production-сред, соответствующих требованиям безопасности и лучшим практикам cloud-архитектуры.

   Особую ценность представляет опыт решения реальных проблем конфигурации, который развивает навыки диагностики и критического мышления при работе с облачными технологиями.
